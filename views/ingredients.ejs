<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/ingredients.css" rel="stylesheet">
  <title>My Meal Prep Ingredients</title>
  <style>
    .no-margin {
      margin: 0;
    }
    .ingredient-box {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <%- include("partials/navbar.ejs") %>
  <h1>My Ingredients</h1>

  <div id="ingredientFrame">
    <div id="myIngredientsFrameTop">
      <a id="myIngredientsInnerFrameTopAddIngredientButton" class="nav" href="/addingredients">Add Ingredients</a>
      <a id="myIngredientsInnerFrameTopManageIngredientsButton" class="nav" href="/findIngredients">Lookup Ingredients</a>
    </div>
    <% for(let i = 0; i < userIngredients.length; i++) { %>
      <div class="ingredient-box" data-id="<%= userIngredients[i].id %>" data-name="<%= userIngredients[i].name %>" data-calories="<%= userIngredients[i].calories %>" data-protein="<%= userIngredients[i].protein %>" data-carbs="<%= userIngredients[i].carbs %>" data-fats="<%= userIngredients[i].fats %>" data-fiber="<%= userIngredients[i].fiber %>" data-sugar="<%= userIngredients[i].sugar %>" data-serving-size-description="<%= userIngredients[i].serving_size_description %>" data-serving-size-amount="<%= userIngredients[i].serving_size_amount %>" data-total-weight-in-grams="<%= userIngredients[i].total_weight_in_grams %>">
        <div id="ingredientFrame-<%= userId %>-<%= userIngredients[i].id %>">
          <div id="ingredientInnerFrameTop">
            <h1><%= userIngredients[i].name %></h1>
          </div>
          <div id="WideLine"></div>
          <div id="ingredientInnerFrameBottom">
            <p class="no-margin"><strong>Calories: </strong> <%= userIngredients[i].calories %></p>
            <p class="no-margin"><strong>Protein (g): </strong> <%= userIngredients[i].protein %></p>
            <p class="no-margin"><strong>Carbs (g): </strong> <%= userIngredients[i].carbs %></p>
            <p class="no-margin"><strong>Fats (g): </strong> <%= userIngredients[i].fats %></p>
            <p class="no-margin"><strong>Fiber (g): </strong> <%= userIngredients[i].fiber %></p>
            <p class="no-margin"><strong>Sugar (g): </strong> <%= userIngredients[i].sugar %></p>
            <p class="no-margin"><strong>Serving Size Description (g): </strong> <%= userIngredients[i].serving_size_description %></p>
            <p class="no-margin"><strong>Serving Size Amount (g): </strong> <%= userIngredients[i].serving_size_amount %></p>
            <p class="no-margin"><strong>Total weight (g): </strong> <%= userIngredients[i].total_weight_in_grams %></p>
          </div>
        </div>
      </div>
    <% } %>
  </div>


  <!-- Bootstrap modal structure for editing ingredients -->
  <div class="modal fade" id="editIngredientModal" tabindex="-1" aria-labelledby="editIngredientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editIngredientModalLabel">Edit Ingredient</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form fields for ingredient data -->
          <input type="hidden" id="editId">

          <div class="mb-3">
            <label for="editName" class="form-label">Name</label>
            <input type="text" class="form-control" id="editName">
          </div>

          <div class="mb-3">
            <label for="editCalories" class="form-label">Calories</label>
            <input type="text" class="form-control" id="editCalories">
          </div>

          <div class="mb-3">
            <label for="editProtein" class="form-label">Protein</label>
            <input type="text" class="form-control" id="editProtein">
          </div>

          <div class="mb-3">
            <label for="editCarbs" class="form-label">Carbs</label>
            <input type="text" class="form-control" id="editCarbs">
          </div>

          <div class="mb-3">
            <label for="editFats" class="form-label">Fats</label>
            <input type="text" class="form-control" id="editFats">
          </div>

          <div class="mb-3">
            <label for="editFiber" class="form-label">Fiber</label>
            <input type="text" class="form-control" id="editFiber">
          </div>

          <div class="mb-3">
            <label for="editSugar" class="form-label">Sugar</label>
            <input type="text" class="form-control" id="editSugar">
          </div>

          <div class="mb-3">
            <label for="editServingSizeDescription" class="form-label">Serving Size Description</label>
            <input type="text" class="form-control" id="editServingSizeDescription">
          </div>

          <div class="mb-3">
            <label for="editServingSizeAmount" class="form-label">Serving Size Amount</label>
            <input type="text" class="form-control" id="editServingSizeAmount">
          </div>

          <div class="mb-3">
            <label for="editTotalWeightInGrams" class="form-label">Total Weight In Grams</label>
            <input type="text" class="form-control" id="editTotalWeightInGrams">
          </div>
         
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="saveEdit">Save changes</button>
        </div>
        </div>
        </div>
        
          </div>
          <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
          
          <script>
            // When the document is ready
            $(document).ready(function () {
              // Event listener for the ingredient box click
              $('.ingredient-box').on('click', function() {
                // Extract all necessary data attributes and populate the modal inputs
                var id = $(this).data('id');
                console.log("id1", id) //shows up correctly as 7
                var ingredientName = $(this).data('name');
                var calories = $(this).data('calories');
                var protein = $(this).data('protein');
                var carbs = $(this).data('carbs');
                var fats = $(this).data('fats');
                var fiber = $(this).data('fiber');
                var sugar = $(this).data('sugar');
                var servingSizeDescription = $(this).data('serving-size-description');
                var servingSizeAmount = $(this).data('serving-size-amount');
                var totalWeightInGrams = $(this).data('total-weight-in-grams');
            
                // Populate the modal fields
                $('#editId').val(id);
                $('#editName').val(ingredientName);
                $('#editCalories').val(calories);
                $('#editProtein').val(protein);
                $('#editCarbs').val(carbs);
                $('#editFats').val(fats);
                $('#editFiber').val(fiber);
                $('#editSugar').val(sugar);
                $('#editServingSizeDescription').val(servingSizeDescription);
                $('#editServingSizeAmount').val(servingSizeAmount);
                $('#editTotalWeightInGrams').val(totalWeightInGrams);


                // Show the modal
                $('#editIngredientModal').modal('show');
              });
        

              // Event listener for delete button click inside modal
              // ... (No changes made here)
        

              // Event listener for save button in edit modal
              $('#saveEdit').on('click', function() {
                var id = $('#editId').val(); //works
                var ingredientName = $('#editName').val();
                var calories = $('#editCalories').val(); 
                var protein = $('#editProtein').val(); 
                var carbs = $('#editCarbs').val(); 
                var fats = $('#editFats').val(); 
                  // AJAX request to update ingredient
                  $.ajax({
                    url: '/updateIngredient/' + id,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                      name: ingredientName,
                      calories: calories,
                      protein: protein,
                      carbs: carbs,
                      fats: fats
                      // Add other fields here
                    }),
                    success: function(result) {
                      // Handle success
                      if(result.success) {
                        $('#editIngredientModal').modal('hide'); // Hide the modal on success
                        window.location.reload(); // Reload the page to update the list
                      } else {
                        alert('Error updating ingredient');
                      }
                    },
                    error: function(xhr, status, error) {
                      // Handle errors
                      alert('An error occurred: ' + xhr.status + ' ' + xhr.statusText);
                    }
                  });
                });
              });
          </script>
        </body>
        </html>